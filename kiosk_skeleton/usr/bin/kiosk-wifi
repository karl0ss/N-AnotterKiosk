#!/bin/bash
# Redirect all output to a log file for debugging
exec &> /var/log/kiosk-wifi.log
set -ex

echo "--- Kiosk WiFi Configuration Starting ---"
date

echo "Reading configuration from /boot/kioskbrowser.ini..."
WIFI_SSID=$(get-ini /boot/kioskbrowser.ini wifi ssid)
WIFI_PSK=$(get-ini /boot/kioskbrowser.ini wifi psk)

if [ -z "${WIFI_SSID}" ]; then
    echo "No WiFi SSID configured. Exiting."
    exit 0
fi

echo "Configuration found: SSID='${WIFI_SSID}'"

echo "Waiting for WiFi adapter to be ready..."
sleep 5

echo "Checking radio status..."
nmcli radio all

echo "Ensuring WiFi radio is on..."
nmcli radio wifi on

echo "Checking device status..."
nmcli device status

echo "Attempting to connect to WiFi network..."
nmcli device wifi connect "${WIFI_SSID}" password "${WIFI_PSK}"

echo "Waiting a few seconds for connection to establish..."
sleep 10

echo "Final connection status:"
nmcli connection show

echo "--- Kiosk WiFi Configuration Finished ---"
